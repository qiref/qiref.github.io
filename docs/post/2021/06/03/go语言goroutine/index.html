<!DOCTYPE html>
<html lang="cn-zh">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title> Goè¯­è¨€goroutine | å¤§é“è‡³ç®€</title>
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xiee/utils/css/article.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xiee/utils/css/heading-anchor.min.css">
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <link rel="stylesheet" href="/css/custom.css" />
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PGMJFXZJRT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-PGMJFXZJRT');
</script>
  </head>

  <body>

    <nav class="menu">
    <ul>
      <li class="left">
        <a href="/"><span>å¤§é“è‡³ç®€</span></a>
      </li>
      
      <li>
        <a href="/post/">Posts</a>
      </li>
      
      <li>
        <a href="/tags/">Tags</a>
      </li>
      
      <li id="menu-search">
        <a href="/#">Search</a>
      </li>
      
    </ul>
    </nav>


<div class="container single">
<main>

<div class="article-meta">
<h1><span class="title">Goè¯­è¨€goroutine</span></h1>

<h3 class="date">2021-06-03</h3>
<p class="terms">
  
  
  
  
  Tags: <a href="/tags/go">Go</a> 
  
  
</p>
</div>

<div class="article">
<p>æ‘˜è¦ï¼šGoè¯­è¨€goroutine</p>
<hr>
<h2 id="goroutineåç¨‹">goroutineåç¨‹</h2>
<p>Go åç¨‹ åœ¨æ‰§è¡Œä¸Šæ¥è¯´æ˜¯è½»é‡çº§çš„çº¿ç¨‹ã€‚goè¯­è¨€å±‚é¢å¹¶ä¸æ”¯æŒå¤šè¿›ç¨‹æˆ–å¤šçº¿ç¨‹ï¼Œä½†æ˜¯åç¨‹æ›´å¥½ç”¨ï¼Œåç¨‹è¢«ç§°ä¸ºç”¨æˆ·æ€çº¿ç¨‹ï¼Œä¸å­˜åœ¨CPUä¸Šä¸‹æ–‡åˆ‡æ¢é—®é¢˜ï¼Œæ•ˆç‡éå¸¸é«˜ã€‚</p>
<p>goè¯­è¨€ä¸­å¯åŠ¨ä¸€ä¸ªåç¨‹éå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨æ‰§è¡Œå‡½æ•°å‰åŠ ä¸Šgoå…³é”®å­—ï¼Œå°±å¯ä»¥å¯ç”¨goroutineã€‚</p>
<pre><code class="language-go">func main() {

	// ä½¿ç”¨åŒ¿åå‡½æ•°å¯ç”¨goroutine
	go func() {
		fmt.Println(&quot;goroutine&quot;)
	}()

	// è°ƒç”¨å‡½æ•°å¯ç”¨goroutine
	go func1()
}

func func1() {
	fmt.Println(&quot;f1() was called.&quot;)
}

</code></pre>
<p>æ²¡é”™å°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œåœ¨goè¯­è¨€ä¸­ï¼Œgoroutineä¼šè¢«æ”¾åˆ°è¿è¡Œé˜Ÿåˆ—runtime.runqputä¸­ï¼Œç„¶åç”±è°ƒåº¦å™¨è°ƒåº¦ã€‚å¹¶éæ˜¯æ¯ä¸€ä¸ªåç¨‹éƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„çº¿ç¨‹å»æ‰§è¡Œï¼Œåç¨‹æ¯”çº¿ç¨‹çš„ç²’åº¦æ›´ç»†ã€‚</p>
<p>ä½†æ˜¯ä¸Šè¿°ä»£ç å¹¶ä¸ä¼šæœ‰è¾“å‡ºç»“æœï¼Œå› ä¸ºè¿˜æ²¡ç­‰func1()å‡½æ•°æ‰§è¡Œå®Œæˆï¼Œmain()å°±å·²ç»æ‰§è¡Œå®Œæˆäº†ã€‚æ‰€ä»¥åœ¨main()å‡½æ•°æ‰§è¡Œå®Œæˆä¹‹å‰sleepä¸€ä¸‹å°±å¯ä»¥çœ‹åˆ°func1()çš„æ‰§è¡Œç»“æœã€‚</p>
<pre><code class="language-go">time.Sleep(time.Second * 1)
</code></pre>
<h2 id="waitgroup">WaitGroup</h2>
<p>sleepè‚¯å®šæ˜¯ä¸é è°±çš„ï¼Œgoè¯­è¨€ä¸­å¯ä»¥ç­‰å¾…åç¨‹æ‰§è¡Œå®Œæˆåå†å›åˆ°ä¸»çº¿ç¨‹ã€‚</p>
<pre><code class="language-go">// å®šä¹‰å…¨å±€å˜é‡
var WG = sync.WaitGroup{}

func main() {
	WG.Add(1)
	go func1()
	WG.Wait()
}

func func1() {
	fmt.Println(&quot;f1() was called.&quot;)
	WG.Done()
}
</code></pre>
<p>åœ¨è°ƒç”¨func1()ä¹‹å‰ï¼Œè°ƒç”¨å…¨å±€å˜é‡WG.Add()æ–¹æ³•ï¼Œç„¶åå¯ç”¨goroutineè°ƒç”¨func1()ï¼Œç„¶åè°ƒç”¨WG.Wait()å‡½æ•°è¿›è¡Œç­‰å¾…ï¼Œfun1()è°ƒç”¨ç»“æŸåï¼Œè°ƒç”¨WG.Done()ã€‚
é€šè¿‡è¯•éªŒå¯ä»¥å‘ç°ï¼šAdd()æ–¹æ³•ä¸­çš„æ•°å€¼ä¸Done()æ–¹æ³•çš„æ•°é‡åº”è¯¥ä¿æŒä¸€è‡´ã€‚å½“Add(2)æ—¶ï¼ŒDone()æ–¹æ³•åº”è¯¥æ‰§è¡Œä¸¤æ¬¡ã€‚ç›´åˆ° WaitGroup è®¡æ•°å™¨æ¢å¤ä¸º 0ï¼› å³æ‰€æœ‰åç¨‹çš„å·¥ä½œéƒ½å·²ç»å®Œæˆã€‚
çœ‹æºç å¯ä»¥å‘ç°ï¼ŒDone()ä¸Add()å®é™…ä¸Šæ˜¯ä¸€ä¸ªå‡½æ•°ã€‚</p>
<pre><code class="language-go">// Done decrements the WaitGroup counter by one.
func (wg *WaitGroup) Done() {
	wg.Add(-1)
}
</code></pre>
<h2 id="å¤šä¸ªgoroutineå¦‚ä½•æ‰§è¡Œ">å¤šä¸ªgoroutineå¦‚ä½•æ‰§è¡Œ</h2>
<pre><code class="language-go">func main() {
	loop := 5
	WG.Add(loop)
	for i := 0; i &lt; loop; i++ {
		go func2(i)
	}
	WG.Wait()
}

// define func2
func func2(i int) {
	fmt.Println(&quot;func2() was called. i is : &quot;, i)
	WG.Done()
}

// è¿è¡Œç»“æœï¼š
//func2() was called. i is : 4
//func2() was called. i is : 2
//func2() was called. i is : 3
//func2() was called. i is : 0
//func2() was called. i is : 1
</code></pre>
<p>æ¯ä¸ªgoroutineçš„è¿è¡Œå¹¶ä¸è§„åˆ™ï¼Œæ¯ä¸ªåç¨‹åœ¨å¹¶å‘æ‰§è¡Œã€‚ğŸ¤”</p>
<p>ä»å®ç°ä¸Šï¼Œæ¯ä¸€ä¸ªgoroutineéƒ½ä¼šåŠ å…¥é˜Ÿåˆ—ä¸­ï¼Œç„¶åè¿™ç»„åç¨‹ç”±è°ƒåº¦å™¨é€šè¿‡å„ç§è°ƒåº¦ç­–ç•¥è¿›è¡Œè°ƒåº¦ã€‚ç„¶åä¼šå¼€å¯å¤šä¸ªçº¿ç¨‹å»è°ƒåº¦åç¨‹å·¥ä½œé˜Ÿåˆ—ï¼Œ
è°ƒåº¦å™¨æœ€å¤šå¯ä»¥åˆ›å»º 10000 ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯å…¶ä¸­å¤§å¤šæ•°çš„çº¿ç¨‹éƒ½ä¸ä¼šæ‰§è¡Œç”¨æˆ·ä»£ç ï¼Œå¤§éƒ¨åˆ†éƒ½è¿›è¡Œè°ƒåº¦å·¥ä½œï¼Œæœ€å¤šåªä¼šæœ‰ GOMAXPROCS ä¸ªæ´»è·ƒçº¿ç¨‹èƒ½å¤Ÿæ­£å¸¸è¿è¡Œã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿è¡Œæ—¶ä¼šå°† GOMAXPROCS è®¾ç½®æˆå½“å‰æœºå™¨çš„æ ¸æ•°ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ç¨‹åºä¸­ä½¿ç”¨ runtime.GOMAXPROCS æ¥æ”¹å˜æœ€å¤§çš„æ´»è·ƒçº¿ç¨‹æ•°ã€‚</p>
<pre><code class="language-go">func main() {
	runtime.GOMAXPROCS(1)
	fmt.Println(runtime.NumGoroutine())
	for i := 0; i &lt; 10; i++ {
		go say(&quot;Hello World: &quot; + strconv.Itoa(i))
	}
	fmt.Println(runtime.NumGoroutine())
	for {
	}
}

func say(s string) {
	println(s)
}
</code></pre>
<p>ç½‘ä¸Šå¾ˆå¤šåœ°æ–¹ç»™å‡ºè¿™ä¸ªä¾‹å­ï¼Œå¹¶ä¸”è¯´å½“<code>runtime.GOMAXPROCS(1)</code>çš„æƒ…å†µä¸‹ï¼Œä¸Šè¿°ä»£ç æ˜¯ä¸ä¼šè¿è¡Œçš„ï¼Œåªæœ‰å½“å‚æ•°å¤§äº1æ—¶ï¼Œæ‰å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œä½†æ˜¯è¯¥ç¤ºä¾‹åœ¨go version go1.16.4 darwin/amd64 ç¯å¢ƒä¸‹å¯ä»¥æ­£å¸¸è¿è¡Œï¼ŒçŒœæµ‹æ˜¯goåç¨‹è°ƒåº¦ç­–ç•¥æ–°ç‰ˆæœ¬ä½œäº†ä¼˜åŒ–ã€‚</p>
<p>å‚è€ƒï¼š</p>
<p><a href="https://zhuanlan.zhihu.com/p/74047342">https://zhuanlan.zhihu.com/p/74047342</a></p>
<p><a href="http://books.studygolang.com/gobyexample/goroutines/">http://books.studygolang.com/gobyexample/goroutines/</a></p>

</div>
</main>

<section class="appendix">





<div>
  <div class="side side-left"><h3>é‡å¤ä½¿ç”¨</h3></div>
  Text and figures are licensed under <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution CC BY 4.0</a>. The source code is licensed under MIT. The full source is available at <a href="https://github.com/qiref/qiref.github.io">https://github.com/qiref/qiref.github.io</a>.
</div>



<div>
  <div class="side side-left"><h3>æ¬¢è¿ä¿®è®¢</h3></div>
  
  
  
    
    
  
  å¦‚æœæ‚¨å‘ç°æœ¬æ–‡é‡Œå«æœ‰ä»»ä½•é”™è¯¯ï¼ˆåŒ…æ‹¬é”™åˆ«å­—å’Œæ ‡ç‚¹ç¬¦å·ï¼‰ï¼Œæ¬¢è¿<a href="https://github.com/qiref/qiref.github.io/tree/master/content/post/2021-06-03-Go%e8%af%ad%e8%a8%80goroutine.md" id="edit-link">åœ¨æœ¬ç«™çš„ GitHub é¡¹ç›®é‡Œæäº¤ä¿®è®¢æ„è§ã€‚</a>
</div>




</section>



<nav class="post-nav">
  <span class="nav-next">&larr; <a href="/post/2021/06/01/go%E8%AF%AD%E8%A8%80%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" title=ä¸‹ä¸€ç¯‡&#32;(æ—§)>Goè¯­è¨€åŸºæœ¬æ•°æ®ç»“æ„</a></span>
  &hercon;
  <span class="nav-prev"><a href="/post/2021/06/05/go%E8%AF%AD%E8%A8%80%E6%8C%87%E9%92%88/" title=ä¸Šä¸€ç¯‡&#32;(æ–°)>Goè¯­è¨€æŒ‡é’ˆ</a> &rarr;</span>
</nav>


<script src="https://utteranc.es/client.js"
        repo="qiref/qiref.github.io"
        issue-term="pathname"
        label="Comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

</div>


  <footer>
  




<script async src="https://www.googletagmanager.com/gtag/js?id=G-PGMJFXZJRT"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-PGMJFXZJRT', { 'anonymize_ip': false });
}
</script>



<script src="https://cdn.jsdelivr.net/combine/npm/@xiee/utils/js/number-sections.min.js,npm/@xiee/utils/js/toc.min.js,npm/@xiee/utils/js/toc-highlight.min.js,npm/@xiee/utils/js/sidenotes.min.js,npm/@xiee/utils/js/right-quote.min.js,npm/@xiee/utils/js/center-img.min.js,npm/@xiee/utils/js/fix-pandoc.min.js,npm/@xiee/utils/js/heading-anchor.min.js" defer></script>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rstudio/markdown/inst/resources/prism-xcode.css">
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js" defer></script>


  <div class="footer">
  
  <ul>
    
    <li class="optional">
      <a href="/post/">Posts</a>
    </li>
    
    <li class="optional">
      <a href="/tags/">Tags</a>
    </li>
    
    <li id="menu-edit">
      <a href="#">Suggest an edit</a>
    </li>
    
    <li>
      <a href="#">Back to top</a>
    </li>
    
  </ul>
  </div>
  
  </footer>
  <script src="/js/features.js" defer></script>
  </body>
</html>

